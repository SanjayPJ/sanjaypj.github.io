<!doctype html><html lang=en-us class="scroll-smooth dark"><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><title>Horizontal Pod Autoscaling with Kubernetes: A Hands-On Guide</title><meta name=description content="This covers setting up Horizontal Pod Autoscaling (HPA) in Kubernetes, including configuring the Metrics Server, dockerizing a Node.js app, and deploying it with HPA. Learn to create Kubernetes configurations and monitor autoscaling with Apache Benchmark to ensure efficient scaling of your application."><link rel=canonical href=https://sanjaypj.github.io/posts/horizontal-pod-autoscaling/><link rel=robots href=/robots.txt><script type=text/javascript src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script type=text/x-mathjax-config>MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']] } });</script><link rel=stylesheet href="https://sanjaypj.github.io/css/app.min.816e52568aa8e02c4c8d1f70afffddd2a236031cceb2123291af265858d2b0fb.css" integrity="sha256-gW5SVoqo4CxMjR9wr//d0qI2AxzOshIyka8mWFjSsPs="></head><body class="max-w-screen-md mx-auto" style=padding-left:20px;padding-right:20px><div class=header><header class="flex flex-col sm:flex-row items-center gap-5 sm:gap-10 pt-16 py-12" style=width:100%><div class="flex-none w-20 h-20 rounded-full overflow-hidden"><a href=https://sanjaypj.github.io/><img src=/img/profile-picture.jpg width=960 height=960 alt="Sanjay PJ"></a></div><div class="flex flex-col gap-5"><a href=https://sanjaypj.github.io/><h1 id=site-title>Sanjay PJ</h1></a><nav><ul><li><a href=/>Home</a></li><li><a href=/posts>Posts</a></li><li><a href=/categories>Categories</a></li><li><a href=/tags>Tags</a></li></ul></nav></div></header><button class=toggle-theme aria-label="Toggle Theme" title="Toggle Theme" onclick=toggleTheme()>
<span class="theme-icon light"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentcolor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386-1.591 1.591M21 12h-2.25m-.386 6.364-1.591-1.591M12 18.75V21m-4.773-4.227-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75.0 11-7.5.0 3.75 3.75.0 017.5.0z"/></svg></span><span class="theme-icon dark"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentcolor"><path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718.0 0118 15.75c-5.385.0-9.75-4.365-9.75-9.75.0-1.33.266-2.597.748-3.752A9.753 9.753.0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753.0 009.002-5.998z"/></svg></span></button>
<script>document.addEventListener("DOMContentLoaded",function(){const e=localStorage.getItem("theme");setTheme(!e||e==="light"?"light":e)});function setTheme(e){const t=document.querySelector("html");localStorage.setItem("theme",e),e==="light"?(t.classList.contains("dark")&&document.querySelector("html").classList.remove("dark"),document.querySelector(".theme-icon.light").style.display="none",document.querySelector(".theme-icon.dark").style.display="block"):(t.classList.contains("dark")||document.querySelector("html").classList.add("dark"),document.querySelector(".theme-icon.dark").style.display="none",document.querySelector(".theme-icon.light").style.display="block")}function toggleTheme(){const e=localStorage.getItem("theme");setTheme(e==="light"?"dark":"light")}</script></div><main id=content><article class="flex flex-col gap-10"><header class="flex flex-col gap-2"><h2 class=title-large>Horizontal Pod Autoscaling with Kubernetes: A Hands-On Guide</h2><div class=meta><time datetime="2024-09-08 09:16:45 +0000 UTC" title='Sun, Sep 8, 2024, 9:16 AM UTC'>08/09/2024 - Estimated reading time: 3 minutes</time>
â€”
<a class=categories href=/categories/tech/ alt=Tech>Tech</a></div></header><section><p>Kubernetes, the powerful orchestration platform for containerized applications, offers numerous features to ensure that your applications are running efficiently and scaling as needed. One of the most impactful features is Horizontal Pod Autoscaling (HPA). In this blog, we&rsquo;ll walk through setting up HPA for a simple Node.js application on a Kubernetes cluster running on Docker Desktop for Windows. We&rsquo;ll cover everything from setting up your environment to deploying a scalable application and testing its autoscaling behavior.</p><h2 id=prerequisites>Prerequisites</h2><ol><li><strong>Docker Desktop for Windows</strong>: Ensure Docker Desktop is installed and Kubernetes is enabled.</li><li><strong>Metrics Server</strong>: Required for HPA to work. It collects resource usage data.</li><li><strong>Apache Benchmark</strong>: For load testing.</li></ol><h2 id=setting-up-metrics-server>Setting Up Metrics Server</h2><ol><li><p><strong>Download and Edit <code>components.yaml</code></strong>:</p><ul><li>Get the latest <code>components.yaml</code> from the <a href=https://github.com/kubernetes-sigs/metrics-server/releases>Metrics Server releases page</a>.</li><li>Open <code>components.yaml</code> in your text editor.</li><li>Add <code>--kubelet-insecure-tls</code> under the <code>args</code> section to bypass TLS verification.</li><li>Save the file.</li></ul></li><li><p><strong>Apply the Configuration</strong>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl apply -f components.yaml
</span></span></code></pre></div></li><li><p><strong>Verify Metrics Server</strong>:</p><ul><li>Check if the metrics server is collecting data:</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl top node
</span></span><span style=display:flex><span>kubectl top pod -A
</span></span></code></pre></div></li></ol><h2 id=creating-and-deploying-a-dockerized-nodejs-application>Creating and Deploying a Dockerized Node.js Application</h2><ol><li><p><strong>Write a Dockerfile</strong>:
Create a <code>Dockerfile</code> in the root directory of your Node.js application:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Dockerfile data-lang=Dockerfile><span style=display:flex><span><span style=color:#6272a4># Use the official Node.js image</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>FROM</span><span style=color:#f1fa8c> node:14</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4># Create and set the working directory</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>WORKDIR</span><span style=color:#f1fa8c> /usr/src/app</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4># Copy package.json and install dependencies</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>COPY</span> package*.json ./
</span></span><span style=display:flex><span><span style=color:#ff79c6>RUN</span> npm install
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4># Copy the rest of the application code</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>COPY</span> . .
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4># Expose the port the app runs on</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>EXPOSE</span><span style=color:#f1fa8c> 3000</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4># Command to run the application</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>CMD</span> [ <span style=color:#f1fa8c>&#34;node&#34;</span>, <span style=color:#f1fa8c>&#34;index.js&#34;</span> ]
</span></span></code></pre></div></li><li><p><strong>Build the Docker Image</strong>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker build -t test/node-example .
</span></span></code></pre></div></li><li><p><strong>Push the Image to Docker Hub</strong>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker tag test/node-example your-dockerhub-username/node-example
</span></span><span style=display:flex><span>docker push your-dockerhub-username/node-example
</span></span></code></pre></div></li></ol><h2 id=kubernetes-configuration-files>Kubernetes Configuration Files</h2><ol><li><p><strong>Deployment Configuration (<code>k8s/deployment.yml</code>)</strong>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#ff79c6>apiVersion</span>: apps/v1
</span></span><span style=display:flex><span><span style=color:#ff79c6>kind</span>: Deployment
</span></span><span style=display:flex><span><span style=color:#ff79c6>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>name</span>: node-example
</span></span><span style=display:flex><span><span style=color:#ff79c6>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>replicas</span>: <span style=color:#bd93f9>1</span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>matchLabels</span>:
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>app</span>: node-example
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>template</span>:
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>metadata</span>:
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>labels</span>:
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>app</span>: node-example
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>spec</span>:
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>containers</span>:
</span></span><span style=display:flex><span>        - <span style=color:#ff79c6>name</span>: node-example
</span></span><span style=display:flex><span>          <span style=color:#ff79c6>image</span>: your-dockerhub-username/node-example
</span></span><span style=display:flex><span>          <span style=color:#ff79c6>imagePullPolicy</span>: Always
</span></span><span style=display:flex><span>          <span style=color:#ff79c6>ports</span>:
</span></span><span style=display:flex><span>            - <span style=color:#ff79c6>containerPort</span>: <span style=color:#bd93f9>3000</span>
</span></span><span style=display:flex><span>          <span style=color:#ff79c6>resources</span>:
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>limits</span>:
</span></span><span style=display:flex><span>              <span style=color:#ff79c6>cpu</span>: <span style=color:#f1fa8c>&#34;0.5&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>requests</span>:
</span></span><span style=display:flex><span>              <span style=color:#ff79c6>cpu</span>: <span style=color:#f1fa8c>&#34;0.25&#34;</span>
</span></span></code></pre></div></li><li><p><strong>Service Configuration (<code>k8s/service.yml</code>)</strong>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#ff79c6>apiVersion</span>: v1
</span></span><span style=display:flex><span><span style=color:#ff79c6>kind</span>: Service
</span></span><span style=display:flex><span><span style=color:#ff79c6>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>name</span>: node-example
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>labels</span>:
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>app</span>: node-example
</span></span><span style=display:flex><span><span style=color:#ff79c6>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>app</span>: node-example
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>ports</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ff79c6>port</span>: <span style=color:#bd93f9>3000</span>
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>protocol</span>: TCP
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>nodePort</span>: <span style=color:#bd93f9>30001</span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>type</span>: LoadBalancer
</span></span></code></pre></div></li><li><p><strong>Horizontal Pod Autoscaler Configuration (<code>k8s/hpa.yml</code>)</strong>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#ff79c6>apiVersion</span>: autoscaling/v1
</span></span><span style=display:flex><span><span style=color:#ff79c6>kind</span>: HorizontalPodAutoscaler
</span></span><span style=display:flex><span><span style=color:#ff79c6>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>name</span>: node-example
</span></span><span style=display:flex><span><span style=color:#ff79c6>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>maxReplicas</span>: <span style=color:#bd93f9>4</span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>minReplicas</span>: <span style=color:#bd93f9>1</span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>scaleTargetRef</span>:
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>apiVersion</span>: apps/v1
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>kind</span>: Deployment
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>name</span>: node-example
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>targetCPUUtilizationPercentage</span>: <span style=color:#bd93f9>50</span>
</span></span></code></pre></div></li><li><p><strong>Apply Configurations</strong>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl apply -f k8s
</span></span></code></pre></div></li></ol><h2 id=monitoring-autoscaling>Monitoring Autoscaling</h2><ol><li><p><strong>Terminal 1 - Monitor Deployments</strong>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#ff79c6>while</span> ($true) {
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>cls
</span></span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic></span>    kubectl get deployments
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>Start-Sleep</span> -Seconds <span style=color:#bd93f9>1</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></li><li><p><strong>Terminal 2 - Monitor HPA</strong>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#ff79c6>while</span> ($true) {
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>cls
</span></span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic></span>    kubectl get hpa
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>Start-Sleep</span> -Seconds <span style=color:#bd93f9>1</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></li></ol><h2 id=testing-autoscaling>Testing Autoscaling</h2><ol><li><p><strong>Install Apache Benchmark</strong>:</p><ul><li>Apache Benchmark is often included with Apache HTTP Server. Install it if you havenâ€™t already.</li></ul></li><li><p><strong>Run Load Test</strong>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ab -c <span style=color:#bd93f9>5</span> -n <span style=color:#bd93f9>1000</span> -t <span style=color:#bd93f9>100000</span> http://127.0.0.1:3000/
</span></span></code></pre></div><p>This command will generate load on your Node.js application and trigger autoscaling based on CPU usage.</p></li></ol><h2 id=conclusion>Conclusion</h2><p>Congratulations! You&rsquo;ve successfully set up Horizontal Pod Autoscaler for a Node.js application on Kubernetes. By monitoring the autoscaling behavior, you can ensure that your application remains responsive under varying loads, leveraging Kubernetes&rsquo; powerful scaling capabilities.</p><p>Happy Scaling! ðŸš€</p><hr><p>Feel free to adjust any specific details according to your setup or preferences.</p></section><footer><div class="pb-14 taxonomy-list tags-list"><a href=/tags/kubernetes/ alt=Kubernetes>Kubernetes</a></div></footer></article></main><footer class="pt-5 pb-10 grid gap-3 sm:grid-cols-2"><div class="text-xs font-semibold text-gray-500 order-2 sm:order-1">Â© 2024 â€”
<a href=https://sanjaypj.github.io/>Sanjay PJ</a></div><div class="order-1 sm:order-2"><ul class="flex sm:justify-end gap-5"><li><a href=https://x.com/iamsanjaypj target=_blank rel="noopener noreferrer">Twitter / X</a></li><li><a href=https://github.com/ghnew target=_blank rel="noopener noreferrer">GitHub</a></li></ul></div></footer></body></html>